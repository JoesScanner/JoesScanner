<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="JoesScanner.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:JoesScanner.ViewModels"
    xmlns:models="clr-namespace:JoesScanner.Models"
    x:Name="SettingsPageRoot"
    x:DataType="vm:SettingsViewModel"
    Shell.NavBarIsVisible="False"
    BackgroundColor="{AppThemeBinding Light=#f3f4f6, Dark=#020617}">

    <!-- Scroll so content works on phone and desktop -->
    <ScrollView>
        <Grid Padding="16">

            <!-- Outer card -->
            <Border
                Padding="16"
                BackgroundColor="{AppThemeBinding Light=White, Dark=#020617}"
                Stroke="#111827"
                StrokeShape="RoundRectangle 24">

                <Border.Shadow>
                    <Shadow
                        Brush="#000000"
                        Offset="0,1"
                        Radius="8"
                        Opacity="0.10" />
                </Border.Shadow>

                <!-- Rows:
                     0 = header
                     1 = connection
                     2 = call queue
                     3 = filters
                     4 = theme -->
                <Grid
                    RowDefinitions="Auto,Auto,Auto,*,Auto"
                    ColumnDefinitions="*">

                    <!-- HEADER CARD -->
                    <Border
                        Grid.Row="0"
                        Padding="12"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="0"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,12">

                        <VerticalStackLayout Spacing="10">

                            <!-- Title and tagline -->
                            <VerticalStackLayout Spacing="2">
                                <Label
                                    Text="Settings"
                                    FontSize="20"
                                    FontAttributes="Bold"
                                    TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />
                                <Label
                                    Text="Adjust connection, call list behavior, filters and theme"
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />
                            </VerticalStackLayout>

                            <!-- Header buttons -->
                            <HorizontalStackLayout
                                Spacing="10"
                                HorizontalOptions="End">

                                <!-- Close button -->
                                <Button
                                    Text="Close"
                                    Style="{StaticResource SecondaryPillButtonStyle}"
                                    Clicked="OnBackClicked" />

                                <!-- Log button -->
                                <Button
                                    Text="Log"
                                    Style="{StaticResource SecondaryPillButtonStyle}"
                                    Clicked="OnLogClicked" />
                            </HorizontalStackLayout>

                        </VerticalStackLayout>
                    </Border>

                    <!-- CONNECTION CARD -->
                    <Border
                        Grid.Row="1"
                        Padding="10"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,12">

                        <!-- 0=title, 1=description, 2=fields, 3=buttons (inline), 4=status -->
                        <Grid
                            RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                            ColumnDefinitions="Auto,*"
                            RowSpacing="6">

                            <!-- Title left -->
                            <Label
                                Grid.Row="0"
                                Grid.Column="0"
                                Text="Connection"
                                FontAttributes="Bold"
                                FontSize="16"
                                HorizontalOptions="Start"
                                MinimumWidthRequest="90"
                                TextColor="{AppThemeBinding Light=#111827, Dark=White}" />

                            <!-- Subscription badge right (level + renewal or trial text) -->
                            <Label
                                Grid.Row="0"
                                Grid.Column="1"
                                Text="{Binding SubscriptionSummary}"
                                IsVisible="{Binding ShowSubscriptionSummary}"
                                FontSize="10"
                                TextColor="{AppThemeBinding Light=#16a34a, Dark=#22c55e}"
                                HorizontalTextAlignment="End"
                                VerticalOptions="Center"
                                LineBreakMode="WordWrap" />

                            <!-- Description -->
                            <Label
                                Grid.Row="1"
                                Grid.Column="0"
                                Grid.ColumnSpan="2"
                                Margin="0,0,0,4"
                                Text="Choose which server the app connects to. Not all servers require user/pass."
                                FontSize="12"
                                TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />

                            <!-- Fields: server on row 0, user/pass on row 1 -->
                            <Grid
                                Grid.Row="2"
                                Grid.Column="0"
                                Grid.ColumnSpan="2"
                                RowDefinitions="Auto,Auto"
                                ColumnDefinitions="*"
                                RowSpacing="4">

                                <!-- Server URL row with buttons on the right -->
                                <Grid
                                    Grid.Row="0"
                                    ColumnDefinitions="Auto,*,Auto"
                                    ColumnSpacing="8"
                                    VerticalOptions="Center">

                                    <Label
                                        Grid.Column="0"
                                        Text="Server"
                                        FontSize="12"
                                        VerticalOptions="Center" />

                                    <Entry
                                        Grid.Column="1"
                                        Text="{Binding ServerUrl}"
                                        Placeholder="https://app.joesscanner.com"
                                        FontSize="12"
                                        HeightRequest="28"
                                        VerticalOptions="Center" />

                                    <HorizontalStackLayout
                                        Grid.Column="2"
                                        Spacing="6"
                                        VerticalOptions="Center">

                                        <Button
                                            Text="Joe's server"
                                            Command="{Binding ResetServerCommand}"
                                            Style="{StaticResource SecondaryPillButtonStyle}" />

                                        <Button
                                            Text="Validate"
                                            Command="{Binding ValidateServerCommand}"
                                            Style="{StaticResource PillButtonStyle}" />
                                    </HorizontalStackLayout>
                                </Grid>

                                <!-- Username and password row -->
                                <Grid
                                    Grid.Row="1"
                                    ColumnDefinitions="Auto,*,Auto,*,Auto"
                                    ColumnSpacing="6">

                                    <!-- Username -->
                                    <Label
                                        Grid.Column="0"
                                        Text="User"
                                        FontSize="12"
                                        VerticalOptions="Center"
                                        TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                                    <Entry
                                        Grid.Column="1"
                                        Text="{Binding BasicAuthUsername}"
                                        Placeholder="Optional"
                                        FontSize="12"
                                        HeightRequest="30" />

                                    <!-- Password -->
                                    <Label
                                        Grid.Column="2"
                                        Text="Pass"
                                        FontSize="12"
                                        VerticalOptions="Center"
                                        TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                                    <Entry
                                        Grid.Column="3"
                                        Text="{Binding BasicAuthPassword}"
                                        Placeholder="Optional"
                                        IsPassword="{Binding IsBasicAuthPasswordHidden}"
                                        FontSize="12"
                                        HeightRequest="30"
                                        Margin="0,0,4,0" />

                                    <!-- Show / Hide -->
                                    <Button
                                        Grid.Column="4"
                                        Text="{Binding BasicAuthPasswordToggleText}"
                                        Command="{Binding ToggleBasicAuthPasswordVisibilityCommand}"
                                        Style="{StaticResource SecondaryPillButtonStyle}"
                                        VerticalOptions="Center" />
                                </Grid>
                            </Grid>
                        </Grid>
                    </Border>

                    <!-- CALL QUEUE CARD -->
                    <Border
                        Grid.Row="2"
                        Padding="16"
                        Margin="0,0,0,12"
                        BackgroundColor="{AppThemeBinding Light=White, Dark=#111827}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16">

                        <Border.Stroke>
                            <SolidColorBrush Color="{AppThemeBinding Light=#e5e7eb, Dark=#1f2937}" />
                        </Border.Stroke>

                        <VerticalStackLayout Spacing="8">
                            <Label
                                Text="Queue Control"
                                FontSize="16"
                                FontAttributes="Bold"
                                TextColor="{AppThemeBinding Light=Black, Dark=White}" />

                            <Label
                                Text="Calls Displayed"
                                FontSize="14"
                                FontAttributes="Bold"
                                TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />

                            <Label
                                Text="Control how many calls are kept in the queue."
                                FontSize="12"
                                TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />

                            <!-- Call list size slider -->
                            <VerticalStackLayout
                                Spacing="4"
                                Margin="0,10,0,0">

                                <Label
                                    Text="{Binding MaxCalls, StringFormat='Keep {0} recent calls'}"
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />

                                <Slider
                                    Minimum="5"
                                    Maximum="50"
                                    Value="{Binding MaxCalls}"
                                    HorizontalOptions="FillAndExpand" />
                            </VerticalStackLayout>
                            <!-- Autospeed slider -->
                            <VerticalStackLayout
                                Spacing="8"
                                Margin="0,10,0,0">

                                <Label
                                    Text="Autospeed"
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />

                                <Label
                                    Text="Automatically enables faster playback speed if the queue gets to far behind. This will help prevent memory issues, especially on devices with less memory."
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />

                                <Label
                                    Text="{Binding AutoSpeedThreshold, StringFormat='Autospeed when {0} calls are waiting'}"
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />

                                <Slider
                                    Minimum="10"
                                    Maximum="100"
                                    Value="{Binding AutoSpeedThreshold}"
                                    HorizontalOptions="FillAndExpand" />

                                <!-- Accessibility -->
                                <VerticalStackLayout
                                    Spacing="6"
                                    Margin="0,12,0,0">
                                    <Label
                                        x:Name="AnnounceNewCallsLabel"
                                        Text="Announce new calls"
                                        FontAttributes="Bold"
                                        FontSize="14"
                                        TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />
                                    <Label
                                        Text="When a screen reader is enabled, new calls will be spoken as they arrive."
                                        FontSize="12"
                                        TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />
                                    <HorizontalStackLayout Spacing="12">
                                        <Switch
                                            IsToggled="{Binding AnnounceNewCalls}"
                                            AutomationProperties.LabeledBy="{x:Reference AnnounceNewCallsLabel}"
                                             />
                                        <Label
                                            Text="{Binding AnnounceNewCalls, StringFormat='Enabled: {0}'}"
                                            FontSize="12"
                                            VerticalTextAlignment="Center"
                                            TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}"
                                             />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                            </VerticalStackLayout>

                        </VerticalStackLayout>
                    </Border>

                    <!-- FILTERS CARD -->
                    <Border
                        Grid.Row="3"
                        Stroke="{AppThemeBinding Light=#e5e7eb, Dark=#374151}"
                        StrokeThickness="1"
                        Padding="12"
                        Margin="0,0,0,12"
                        BackgroundColor="{AppThemeBinding Light=#ffffff, Dark=#111827}"
                        StrokeShape="RoundRectangle 8">

                        <VerticalStackLayout Spacing="8">

                            <!-- Header -->
                            <Label
                                Text="Filters"
                                FontSize="16"
                                FontAttributes="Bold"
                                TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                            <Label
                                Text="Mute or hide traffic by Receiver, Site, or Talkgroup."
                                FontSize="12"
                                Opacity="0.8"
                                TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />

                            <!-- Table header row -->
                            <Grid
                                ColumnDefinitions="*,50,50,60"
                                RowDefinitions="Auto"
                                Padding="5,4,5,2">

                                <Label
                                    Grid.Column="0"
                                    Text="Receiver > Site > Talkgroup"
                                    FontSize="11"
                                    FontAttributes="Bold"
                                    VerticalOptions="Center" />

                                <Label
                                    Grid.Column="1"
                                    Text="Mute"
                                    FontSize="11"
                                    FontAttributes="Bold"
                                    HorizontalOptions="Center"
                                    HorizontalTextAlignment="Center"
                                    VerticalOptions="Center" />

                                <Label
                                    Grid.Column="2"
                                    Text="Disable"
                                    FontSize="11"
                                    FontAttributes="Bold"
                                    HorizontalOptions="Center"
                                    HorizontalTextAlignment="Center"
                                    VerticalOptions="Center" />

                                <Label
                                    Grid.Column="3"
                                    Text="Clear"
                                    FontSize="11"
                                    FontAttributes="Bold"
                                    HorizontalOptions="Center"
                                    HorizontalTextAlignment="Center"
                                    VerticalOptions="Center" />
                            </Grid>

                            <!-- Filters table -->
                            <CollectionView
                                x:Name="FiltersList"
                                ItemsSource="{Binding FilterRules}"
                                VerticalOptions="FillAndExpand"
                                SelectionMode="None">

                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout
                                        Orientation="Vertical"
                                        ItemSpacing="2" />
                                </CollectionView.ItemsLayout>

                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:FilterRule">
                                        <Grid
                                            ColumnDefinitions="*,50,50,60"
                                            Padding="0,2">

                                            <!-- Display key -->
                                            <Label
                                                Grid.Column="0"
                                                Text="{Binding DisplayKey}"
                                                FontSize="11"
                                                LineBreakMode="TailTruncation"
                                                MaxLines="1"
                                                VerticalOptions="Center" />

                                            <!-- Mute "button" -->
                                            <Border
                                                Grid.Column="1"
                                                Stroke="{AppThemeBinding Light=#d1d5db, Dark=#4b5563}"
                                                StrokeThickness="1"
                                                StrokeShape="RoundRectangle 4"
                                                Padding="5,4,5,2"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                BackgroundColor="Transparent">

                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer
                                                        Tapped="OnMuteFilterTapped"
                                                        CommandParameter="{Binding}" />
                                                </Border.GestureRecognizers>

                                                <Label
                                                    FontSize="10"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center">
                                                    <Label.Triggers>
                                                        <!-- When muted, show Unmute -->
                                                        <DataTrigger
                                                            TargetType="Label"
                                                            Binding="{Binding IsMuted}"
                                                            Value="True">
                                                            <Setter Property="Text" Value="Unmute" />
                                                        </DataTrigger>
                                                        <!-- When not muted, show Mute -->
                                                        <DataTrigger
                                                            TargetType="Label"
                                                            Binding="{Binding IsMuted}"
                                                            Value="False">
                                                            <Setter Property="Text" Value="Mute" />
                                                        </DataTrigger>
                                                    </Label.Triggers>
                                                </Label>

                                                <Border.Triggers>
                                                    <!-- Muted = yellow -->
                                                    <DataTrigger
                                                        TargetType="Border"
                                                        Binding="{Binding IsMuted}"
                                                        Value="True">
                                                        <Setter Property="BackgroundColor" Value="#f59e0b" />
                                                    </DataTrigger>

                                                    <!-- Not muted = clear -->
                                                    <DataTrigger
                                                        TargetType="Border"
                                                        Binding="{Binding IsMuted}"
                                                        Value="False">
                                                        <Setter Property="BackgroundColor" Value="Transparent" />
                                                    </DataTrigger>
                                                </Border.Triggers>
                                            </Border>

                                            <!-- Disable "button" -->
                                            <Border
                                                Grid.Column="2"
                                                Stroke="{AppThemeBinding Light=#d1d5db, Dark=#4b5563}"
                                                StrokeThickness="1"
                                                StrokeShape="RoundRectangle 4"
                                                Padding="5,4,5,2"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                BackgroundColor="Transparent">

                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer
                                                        Tapped="OnDisableFilterTapped"
                                                        CommandParameter="{Binding}" />
                                                </Border.GestureRecognizers>

                                                <Label
                                                    FontSize="10"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center">
                                                    <Label.Triggers>
                                                        <!-- When disabled, show Enable -->
                                                        <DataTrigger
                                                            TargetType="Label"
                                                            Binding="{Binding IsDisabled}"
                                                            Value="True">
                                                            <Setter Property="Text" Value="Enable" />
                                                        </DataTrigger>
                                                        <!-- When not disabled, show Disable -->
                                                        <DataTrigger
                                                            TargetType="Label"
                                                            Binding="{Binding IsDisabled}"
                                                            Value="False">
                                                            <Setter Property="Text" Value="Disable" />
                                                        </DataTrigger>
                                                    </Label.Triggers>
                                                </Label>

                                                <Border.Triggers>
                                                    <!-- Disabled = red -->
                                                    <DataTrigger
                                                        TargetType="Border"
                                                        Binding="{Binding IsDisabled}"
                                                        Value="True">
                                                        <Setter Property="BackgroundColor" Value="#ef4444" />
                                                    </DataTrigger>

                                                    <!-- Not disabled = clear -->
                                                    <DataTrigger
                                                        TargetType="Border"
                                                        Binding="{Binding IsDisabled}"
                                                        Value="False">
                                                        <Setter Property="BackgroundColor" Value="Transparent" />
                                                    </DataTrigger>
                                                </Border.Triggers>
                                            </Border>

                                            <!-- Clear "button" -->
                                            <Border
                                                Grid.Column="3"
                                                Stroke="{AppThemeBinding Light=#d1d5db, Dark=#4b5563}"
                                                StrokeThickness="1"
                                                StrokeShape="RoundRectangle 4"
                                                Padding="5,4,5,2"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center"
                                                BackgroundColor="Transparent">

                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer
                                                        Tapped="OnClearFilterTapped"
                                                        CommandParameter="{Binding}" />
                                                </Border.GestureRecognizers>

                                                <Label
                                                    FontSize="10"
                                                    Text="Clear"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center" />
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                        </VerticalStackLayout>
                    </Border>

                    <!-- THEME CARD -->
                    <Border
                        Grid.Row="4"
                        Stroke="{AppThemeBinding Light=#e5e7eb, Dark=#374151}"
                        StrokeThickness="1"
                        Padding="12"
                        BackgroundColor="{AppThemeBinding Light=#ffffff, Dark=#111827}"
                        StrokeShape="RoundRectangle 8">

                        <VerticalStackLayout Spacing="10">
                            <Label
                                Text="Theme"
                                FontSize="16"
                                FontAttributes="Bold"
                                TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                            <Label
                                Text="Choose System, Light, or Dark."
                                FontSize="12"
                                Opacity="0.8"
                                TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />

                            <VerticalStackLayout Spacing="6">
                                <HorizontalStackLayout Spacing="10">
                                    <RadioButton
                                        Content="System"
                                        IsChecked="{Binding IsThemeSystem}" />
                                    <RadioButton
                                        Content="Light"
                                        IsChecked="{Binding IsThemeLight}" />
                                    <RadioButton
                                        Content="Dark"
                                        IsChecked="{Binding IsThemeDark}" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </Border>

                </Grid>
            </Border>
        </Grid>
    </ScrollView>
</ContentPage>
