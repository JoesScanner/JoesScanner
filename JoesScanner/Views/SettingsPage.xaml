<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="JoesScanner.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:JoesScanner.ViewModels"
    x:Name="SettingsRoot"
    x:DataType="vm:SettingsViewModel"
    Shell.NavBarIsVisible="False"
    BackgroundColor="{AppThemeBinding Light=#f3f4f6, Dark=#020617}">

    <!-- Scroll so content works on phone and desktop -->
    <ScrollView>
        <Grid Padding="16">
            <!-- Outer card -->
            <Border
                Padding="16"
                BackgroundColor="{AppThemeBinding Light=White, Dark=#020617}"
                Stroke="#111827"
                StrokeShape="RoundRectangle 24">

                <Border.Shadow>
                    <Shadow
                        Brush="#000000"
                        Offset="0,1"
                        Radius="8"
                        Opacity="0.10" />
                </Border.Shadow>

                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" ColumnDefinitions="*">

                    <!-- HEADER CARD -->
                    <Border
                        Grid.Row="0"
                        Padding="12"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="0"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,12">

                        <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                            <VerticalStackLayout Grid.Column="0" Spacing="2">
                                <Label
                                    Text="Settings"
                                    FontSize="20"
                                    FontAttributes="Bold"
                                    TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />
                                <Label
                                    Text="Adjust connection, call list behavior, filters and theme"
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />
                            </VerticalStackLayout>

                            <Button
                                    Text="Save"
                                    Command="{Binding SaveCommand}"
                                    Style="{StaticResource PillButtonStyle}"
                                    >
                                <Button.Triggers>
                                    <!-- Save button turns red when ANY relevant setting has changed -->
                                    <DataTrigger
                                            TargetType="Button"
                                            Binding="{Binding HasUnsavedSettings}"
                                            Value="True">

                                        <Setter Property="BackgroundColor" Value="#b91c1c" />
                                        <Setter Property="TextColor" Value="White" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>

                            <Button
                                Grid.Column="1"
                                Text="Close"
                                Style="{StaticResource SecondaryPillButtonStyle}
                                "
                                Clicked="OnBackClicked" />
                        </Grid>
                    </Border>

                    <!-- CONNECTION CARD -->
                    <Border
                        Grid.Row="1"
                        Padding="12"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,12">

                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*">
                            <Label
                                Grid.Row="0"
                                Text="Connection"
                                FontSize="16"
                                FontAttributes="Bold"
                                Margin="0,0,0,8"
                                TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                            <VerticalStackLayout
                                Grid.Row="1"
                                Spacing="4">

                                <Label
                                    Text="Choose which server the app connects to."
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />

                                <!-- Default vs custom connection -->
                                <HorizontalStackLayout Spacing="12">
                                    <RadioButton
                                        Content="Use default connection"
                                        GroupName="ConnectionMode"
                                        IsChecked="{Binding UseDefaultConnection}" />

                                    <RadioButton
                                        Content="Custom server"
                                        GroupName="ConnectionMode"
                                        IsChecked="{Binding UseDefaultConnection, Converter={StaticResource InverseBooleanConverter}}" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>

                            <!-- Server URL entry -->
                            <Grid
                                Grid.Row="2"
                                ColumnDefinitions="*"
                                ColumnSpacing="8"
                                VerticalOptions="Center">

                                <Entry
                                    Grid.Column="0"
                                    Text="{Binding ServerUrl}"
                                    Placeholder="Server url"
                                    IsEnabled="{Binding UseDefaultConnection, Converter={StaticResource InverseBooleanConverter}}"
                                    FontSize="13" />
                            </Grid>

                            <!-- Save button only for connection changes -->
                            <Grid
                                Grid.Row="3"
                                ColumnDefinitions="*,Auto"
                                Margin="0,8,0,0">

                                <Label
                                    Grid.Column="0"
                                    Text=""
                                    FontSize="11" />
                            </Grid>
                        </Grid>
                    </Border>


                    <!-- CALL LIST BEHAVIOR CARD -->
                    <Border
                        Grid.Row="2"
                        Padding="16"
                        Margin="0,12,0,12"
                        BackgroundColor="{AppThemeBinding Light=White, Dark=#111827}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16">

                        <Border.Stroke>
                            <SolidColorBrush Color="{AppThemeBinding Light=#e5e7eb, Dark=#1f2937}" />
                        </Border.Stroke>

                        <VerticalStackLayout Spacing="8">
                            <Label
                                Text="Call Queue"
                                FontSize="16"
                                FontAttributes="Bold"
                                TextColor="{AppThemeBinding Light=#111827, Dark=White}" />

                            <Label
                                Text="Control how many calls are kept in the queue."
                                FontSize="12"
                                TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />

                            <!-- Call list size slider -->
                            <VerticalStackLayout Spacing="4" Margin="0,10,0,0">
                                <Label
                                    Text="{Binding MaxCalls, StringFormat='Keep {0} recent calls'}"
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />

                                <Slider
                                    Minimum="10"
                                    Maximum="50"
                                    Value="{Binding MaxCalls}"
                                    HorizontalOptions="FillAndExpand" />

                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </Border>

                    <!-- THEME CARD -->
                    <Border
                        Grid.Row="4"
                        Padding="12"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,12">

                        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*">
                            <Label
                                Grid.Row="0"
                                Text="Theme"
                                FontSize="16"
                                FontAttributes="Bold"
                                Margin="0,0,0,8"
                                TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                            <HorizontalStackLayout
                                Grid.Row="1"
                                Spacing="12">

                                <RadioButton
                                    Content="System"
                                    GroupName="ThemeMode"
                                    IsChecked="{Binding IsThemeSystem}" />

                                <RadioButton
                                    Content="Light"
                                    GroupName="ThemeMode"
                                    IsChecked="{Binding IsThemeLight}" />

                                <RadioButton
                                    Content="Dark"
                                    GroupName="ThemeMode"
                                    IsChecked="{Binding IsThemeDark}" />
                            </HorizontalStackLayout>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </ScrollView>
</ContentPage>
