<ContentPage
    x:Class="JoesScanner.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:JoesScanner.ViewModels"
    xmlns:models="clr-namespace:JoesScanner.Models"
    x:Name="SettingsPageRoot"
    x:DataType="vm:SettingsViewModel"
    Shell.NavBarIsVisible="False"
    BackgroundColor="{AppThemeBinding Light=#f3f4f6, Dark=#020617}">


    <!-- Scroll so content works on phone and desktop -->
    <ScrollView>
        <Grid Padding="16">

            <!-- Outer card -->
            <Border
                Padding="16"
                BackgroundColor="{AppThemeBinding Light=White, Dark=#020617}"
                Stroke="#111827"
                StrokeShape="RoundRectangle 24">

                <Border.Shadow>
                    <Shadow
                        Brush="#000000"
                        Offset="0,1"
                        Radius="8"
                        Opacity="0.10" />
                </Border.Shadow>

                <!-- 5 rows:
                     0 = header
                     1 = connection
                     2 = call queue
                     3 = filters
                     4 = theme -->
                <Grid RowDefinitions="Auto,Auto,Auto,*,Auto"
                      ColumnDefinitions="*">

                    <!-- HEADER CARD -->
                    <Border
                        Grid.Row="0"
                        Padding="12"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="0"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,12">

                        <Grid ColumnDefinitions="*,Auto,Auto"
                              VerticalOptions="Center">

                            <VerticalStackLayout Grid.Column="0" Spacing="2">
                                <Label
                                    Text="Settings"
                                    FontSize="20"
                                    FontAttributes="Bold"
                                    TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />
                                <Label
                                    Text="Adjust connection, call list behavior, filters and theme"
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />
                            </VerticalStackLayout>

                            <!-- Save button (turns red when HasUnsavedSettings is true) -->
                            <Button
                                Grid.Column="1"
                                Text="Save"
                                Command="{Binding SaveCommand}"
                                Style="{StaticResource PillButtonStyle}">
                                <Button.Triggers>
                                    <DataTrigger
                                        TargetType="Button"
                                        Binding="{Binding HasUnsavedSettings}"
                                        Value="True">
                                        <Setter Property="BackgroundColor" Value="#b91c1c" />
                                        <Setter Property="TextColor" Value="White" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>

                            <!-- Close button -->
                            <Button
                                Grid.Column="2"
                                Text="Close"
                                Style="{StaticResource SecondaryPillButtonStyle}"
                                Clicked="OnBackClicked" />
                        </Grid>
                    </Border>

                    <!-- CONNECTION CARD -->
                    <Border
                        Grid.Row="1"
                        Padding="10"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,12">

                        <!-- 0=title, 1=description, 2=fields (username/password + server), 3=buttons, 4=status -->
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                              ColumnDefinitions="*"
                              RowSpacing="6">

                            <!-- Title -->
                            <Label
                                Grid.Row="0"
                                Text="Connection"
                                FontAttributes="Bold"
                                FontSize="16"
                                TextColor="{AppThemeBinding Light=#111827, Dark=White}" />

                            <!-- Description -->
                            <Label
                                Grid.Row="1"
                                Margin="0,0,0,4"
                                Text="Choose which server the app connects to."
                                FontSize="12"
                                TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />

                            <!-- Fields: username + password (same row) and server url (row below) -->
                            <Grid Grid.Row="2"
                                  RowDefinitions="Auto,Auto"
                                  ColumnDefinitions="*"
                                  RowSpacing="4">

                                <!-- Username + Password row -->
                                <Grid Grid.Row="0"
                                      ColumnDefinitions="Auto,*,Auto,*,Auto"
                                      ColumnSpacing="6">

                                    <!-- Username label -->
                                    <Label
                                        Grid.Column="0"
                                        Text="Username"
                                        FontSize="12"
                                        VerticalOptions="Center"
                                        TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                                    <!-- Username entry -->
                                    <Entry
                                        Grid.Column="1"
                                        Text="{Binding BasicAuthUsername}"
                                        Placeholder="Optional"
                                        FontSize="12"
                                        HeightRequest="30" />

                                    <!-- Password label -->
                                    <Label
                                        Grid.Column="2"
                                        Text="Password"
                                        FontSize="12"
                                        VerticalOptions="Center"
                                        TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                                    <!-- Password entry -->
                                    <Entry
                                        Grid.Column="3"
                                        Text="{Binding BasicAuthPassword}"
                                        Placeholder="Optional"
                                        IsPassword="{Binding IsBasicAuthPasswordHidden}"
                                        FontSize="12"
                                        HeightRequest="30"
                                        Margin="0,0,4,0" />

                                    <!-- Show/Hide button -->
                                    <Button
                                        Grid.Column="4"
                                        Text="{Binding BasicAuthPasswordToggleText}"
                                        Command="{Binding ToggleBasicAuthPasswordVisibilityCommand}"
                                        Style="{StaticResource SecondaryPillButtonStyle}"
                                        VerticalOptions="Center" />

                                </Grid>

                                <!-- Server URL row with buttons on the right -->
                                <Grid Grid.Row="1"
                                      ColumnDefinitions="Auto,*,Auto"
                                      ColumnSpacing="8"
                                      VerticalOptions="Center">

                                    <!-- Server label -->
                                    <Label
                                        Grid.Column="0"
                                        Text="Server"
                                        FontSize="12"
                                        VerticalOptions="Center" />

                                    <!-- Server URL entry -->
                                    <Entry
                                        Grid.Column="1"
                                        Text="{Binding ServerUrl}"
                                        Placeholder="https://app.joesscanner.com"
                                        FontSize="12"
                                        HeightRequest="28"
                                        VerticalOptions="Center" />

                                    <!-- Buttons to the right -->
                                    <HorizontalStackLayout
                                        Grid.Column="2"
                                        Spacing="6"
                                        VerticalOptions="Center">

                                        <Button
                                            Text="Joe's server"
                                            Command="{Binding ResetServerCommand}"
                                            Style="{StaticResource SecondaryPillButtonStyle}" />

                                        <Button
                                            Text="Validate"
                                            Command="{Binding ValidateServerCommand}"
                                            Style="{StaticResource PillButtonStyle}" />

                                    </HorizontalStackLayout>
                                </Grid>
                            </Grid>

                            <!-- Inline validation status -->
                            <Label
                                Grid.Row="4"
                                Margin="0,4,0,0"
                                FontSize="11"
                                IsVisible="{Binding HasServerValidationResult}"
                                Text="{Binding ServerValidationMessage}">

                                <Label.Triggers>
                                    <!-- Error: red -->
                                    <DataTrigger
                                        TargetType="Label"
                                        Binding="{Binding IsServerValidationError}"
                                        Value="True">
                                        <Setter
                                            Property="TextColor"
                                            Value="#ef4444" />
                                    </DataTrigger>

                                    <!-- Success: green -->
                                    <DataTrigger
                                        TargetType="Label"
                                        Binding="{Binding IsServerValidationError}"
                                        Value="False">
                                        <Setter
                                            Property="TextColor"
                                            Value="#22c55e" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>

                        </Grid>
                    </Border>


                    <!-- CALL QUEUE CARD -->
                    <Border
                        Grid.Row="2"
                        Padding="16"
                        Margin="0,0,0,12"
                        BackgroundColor="{AppThemeBinding Light=White, Dark=#111827}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16">

                        <Border.Stroke>
                            <SolidColorBrush Color="{AppThemeBinding Light=#e5e7eb, Dark=#1f2937}" />
                        </Border.Stroke>

                        <VerticalStackLayout Spacing="8">
                            <Label
                                Text="Call Queue"
                                FontSize="16"
                                FontAttributes="Bold"
                                TextColor="{AppThemeBinding Light=#111827, Dark=White}" />

                            <Label
                                Text="Control how many calls are kept in the queue."
                                FontSize="12"
                                TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />

                            <!-- Call list size slider -->
                            <VerticalStackLayout Spacing="4" Margin="0,10,0,0">
                                <Label
                                    Text="{Binding MaxCalls, StringFormat='Keep {0} recent calls'}"
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />

                                <Slider
                                    Minimum="10"
                                    Maximum="50"
                                    Value="{Binding MaxCalls}"
                                    HorizontalOptions="FillAndExpand" />
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </Border>

                    <!-- FILTERS CARD -->
                    <Border
                        Grid.Row="3"
                        Stroke="{AppThemeBinding Light=#e5e7eb, Dark=#374151}"
                        StrokeThickness="1"
                        Padding="12"
                        Margin="0,0,0,12"
                        BackgroundColor="{AppThemeBinding Light=#ffffff, Dark=#111827}"
                        StrokeShape="RoundRectangle 8">

                        <VerticalStackLayout Spacing="8">

                            <!-- Header -->
                            <Label Text="Filters"
                                   FontSize="16"
                                   FontAttributes="Bold" />

                            <Label Text="Mute or hide traffic by Receiver, Site, or Talkgroup."
                                   FontSize="12"
                                   Opacity="0.8" />

                            <!-- Table header row -->
                            <Grid ColumnDefinitions="*,44,54,56"
                              RowDefinitions="Auto"
                              Padding="5,4,5,2">

                                <Label Text="Receiver > Site > Talkgroup"
                                   Grid.Column="0"
                                   FontSize="11"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center" />

                                <Label Text="Mute"
                                   Grid.Column="1"
                                   FontSize="11"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center"
                                   HorizontalTextAlignment="Center"
                                   VerticalOptions="Center" />

                                <Label Text="Disable"
                                   Grid.Column="2"
                                   FontSize="11"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center"
                                   HorizontalTextAlignment="Center"
                                   VerticalOptions="Center" />

                                <Label Text="Clear"
                                   Grid.Column="3"
                                   FontSize="11"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center"
                                   HorizontalTextAlignment="Center"
                                   VerticalOptions="Center" />
                            </Grid>


                            <!-- Filters table -->
                            <CollectionView
                                x:Name="FiltersList"
                                ItemsSource="{Binding FilterRules}"
                                VerticalOptions="FillAndExpand"
                                SelectionMode="None">

                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Vertical"
                                                       ItemSpacing="2" />
                                </CollectionView.ItemsLayout>

                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:FilterRule">
                                        <Grid ColumnDefinitions="*,50,50,60"
                                            Padding="0,2">

                                            <!-- Display key -->
                                            <Label Text="{Binding DisplayKey}"
                                               FontSize="11"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="1"
                                               VerticalOptions="Center"
                                               Grid.Column="0" />

                                            <!-- Mute "button" -->
                                            <Border Grid.Column="1"
                                                    Stroke="{AppThemeBinding Light=#d1d5db, Dark=#4b5563}"
                                                    StrokeThickness="1"
                                                    StrokeShape="RoundRectangle 4"
                                                    Padding="5,4,5,2"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center"
                                                    BackgroundColor="Transparent">

                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer
                                                        Tapped="OnMuteFilterTapped"
                                                        CommandParameter="{Binding}" />
                                                </Border.GestureRecognizers>

                                                <Label FontSize="10"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center">
                                                    <Label.Triggers>
                                                        <!-- When muted, show Unmute -->
                                                        <DataTrigger TargetType="Label"
                                                                     Binding="{Binding IsMuted}"
                                                                     Value="True">
                                                            <Setter Property="Text" Value="Unmute" />
                                                        </DataTrigger>
                                                        <!-- When not muted, show Mute -->
                                                        <DataTrigger TargetType="Label"
                                                                     Binding="{Binding IsMuted}"
                                                                     Value="False">
                                                            <Setter Property="Text" Value="Mute" />
                                                        </DataTrigger>
                                                    </Label.Triggers>
                                                </Label>

                                                <Border.Triggers>
                                                    <!-- Muted = yellow -->
                                                    <DataTrigger TargetType="Border"
                                                                 Binding="{Binding IsMuted}"
                                                                 Value="True">
                                                        <Setter Property="BackgroundColor" Value="#f59e0b" />
                                                    </DataTrigger>

                                                    <!-- Not muted = clear -->
                                                    <DataTrigger TargetType="Border"
                                                                 Binding="{Binding IsMuted}"
                                                                 Value="False">
                                                        <Setter Property="BackgroundColor" Value="Transparent" />
                                                    </DataTrigger>
                                                </Border.Triggers>
                                            </Border>

                                            <!-- Disable "button" -->
                                            <Border Grid.Column="2"
                                                    Stroke="{AppThemeBinding Light=#d1d5db, Dark=#4b5563}"
                                                    StrokeThickness="1"
                                                    StrokeShape="RoundRectangle 4"
                                                    Padding="5,4,5,2"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center"
                                                    BackgroundColor="Transparent">

                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer
                                                        Tapped="OnDisableFilterTapped"
                                                        CommandParameter="{Binding}" />
                                                </Border.GestureRecognizers>

                                                <Label FontSize="10"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center">
                                                    <Label.Triggers>
                                                        <!-- When disabled, show Enable -->
                                                        <DataTrigger TargetType="Label"
                                                                     Binding="{Binding IsDisabled}"
                                                                     Value="True">
                                                            <Setter Property="Text" Value="Enable" />
                                                        </DataTrigger>
                                                        <!-- When not disabled, show Disable -->
                                                        <DataTrigger TargetType="Label"
                                                                     Binding="{Binding IsDisabled}"
                                                                     Value="False">
                                                            <Setter Property="Text" Value="Disable" />
                                                        </DataTrigger>
                                                    </Label.Triggers>
                                                </Label>

                                                <Border.Triggers>
                                                    <!-- Disabled = red -->
                                                    <DataTrigger TargetType="Border"
                                                                 Binding="{Binding IsDisabled}"
                                                                 Value="True">
                                                        <Setter Property="BackgroundColor" Value="#ef4444" />
                                                    </DataTrigger>

                                                    <!-- Enabled = clear -->
                                                    <DataTrigger TargetType="Border"
                                                                 Binding="{Binding IsDisabled}"
                                                                 Value="False">
                                                        <Setter Property="BackgroundColor" Value="Transparent" />
                                                    </DataTrigger>
                                                </Border.Triggers>
                                            </Border>

                                            <!-- Clear "button" -->
                                            <Border Grid.Column="3"
                                                Stroke="{AppThemeBinding Light=#d1d5db, Dark=#4b5563}"
                                                StrokeThickness="1"
                                                StrokeShape="RoundRectangle 4"
                                                Padding="5,4,5,2"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Center">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer
                                                        Tapped="OnClearFilterTapped"
                                                        CommandParameter="{Binding}" />
                                                </Border.GestureRecognizers>

                                                <Label Text="Clear"
                                                   FontSize="10"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center" />
                                            </Border>


                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>


                            </CollectionView>

                            <Label Text="Filters are created automatically as calls arrive. Clearing a row removes it until new traffic recreates it."
                                   FontSize="10"
                                   Opacity="0.6"
                                   LineBreakMode="WordWrap" />

                        </VerticalStackLayout>
                    </Border>

                    <!-- THEME CARD -->
                    <Border
                        Grid.Row="4"
                        Padding="12"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,0">

                        <Grid RowDefinitions="Auto,Auto"
                              ColumnDefinitions="*">
                            <Label
                                Grid.Row="0"
                                Text="Theme"
                                FontSize="16"
                                FontAttributes="Bold"
                                Margin="0,0,0,8"
                                TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                            <HorizontalStackLayout
                                Grid.Row="1"
                                Spacing="12">

                                <RadioButton
                                    Content="System"
                                    GroupName="ThemeMode"
                                    IsChecked="{Binding IsThemeSystem}" />

                                <RadioButton
                                    Content="Light"
                                    GroupName="ThemeMode"
                                    IsChecked="{Binding IsThemeLight}" />

                                <RadioButton
                                    Content="Dark"
                                    GroupName="ThemeMode"
                                    IsChecked="{Binding IsThemeDark}" />
                            </HorizontalStackLayout>
                        </Grid>
                    </Border>

                </Grid>
            </Border>
        </Grid>
    </ScrollView>
</ContentPage>
