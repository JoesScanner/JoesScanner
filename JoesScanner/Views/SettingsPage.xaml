<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="JoesScanner.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:JoesScanner.ViewModels"
    x:Name="SettingsRoot"
    x:DataType="vm:SettingsViewModel"
    Shell.NavBarIsVisible="False"
    BackgroundColor="{AppThemeBinding Light=#f3f4f6, Dark=#020617}">

    <!-- Scroll so content works on phone and desktop -->
    <ScrollView>
        <Grid Padding="16">
            <!-- Outer card -->
            <Border
                Padding="16"
                BackgroundColor="{AppThemeBinding Light=White, Dark=#020617}"
                Stroke="#111827"
                StrokeShape="RoundRectangle 24">

                <Border.Shadow>
                    <Shadow
                        Brush="#000000"
                        Offset="0,1"
                        Radius="8"
                        Opacity="0.10" />
                </Border.Shadow>

                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" ColumnDefinitions="*">

                    <!-- HEADER CARD -->
                    <Border
                        Grid.Row="0"
                        Padding="12"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="0"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,12">

                        <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                            <VerticalStackLayout Grid.Column="0" Spacing="2">
                                <Label
                                    Text="Settings"
                                    FontSize="20"
                                    FontAttributes="Bold"
                                    TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />
                                <Label
                                    Text="Adjust connection, call list behavior, filters and theme"
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />
                            </VerticalStackLayout>

                            <Button
                                Grid.Column="1"
                                Text="Close"
                                Style="{StaticResource SecondaryPillButtonStyle}
                                "
                                Clicked="OnBackClicked" />
                        </Grid>
                    </Border>

                    <!-- CONNECTION CARD -->
                    <Border
                        Grid.Row="1"
                        Padding="12"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,12">

                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*">
                            <Label
                                Grid.Row="0"
                                Text="Connection"
                                FontSize="16"
                                FontAttributes="Bold"
                                Margin="0,0,0,8"
                                TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                            <VerticalStackLayout
                                Grid.Row="1"
                                Spacing="4">

                                <Label
                                    Text="Choose which server the app connects to."
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />

                                <!-- Default vs custom connection -->
                                <HorizontalStackLayout Spacing="12">
                                    <RadioButton
                                        Content="Use default connection"
                                        GroupName="ConnectionMode"
                                        IsChecked="{Binding UseDefaultConnection}" />

                                    <RadioButton
                                        Content="Custom server"
                                        GroupName="ConnectionMode"
                                        IsChecked="{Binding UseDefaultConnection, Converter={StaticResource InverseBooleanConverter}}" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>

                            <!-- Server URL entry -->
                            <Grid
                                Grid.Row="2"
                                ColumnDefinitions="*"
                                ColumnSpacing="8"
                                VerticalOptions="Center">

                                <Entry
                                    Grid.Column="0"
                                    Text="{Binding ServerUrl}"
                                    Placeholder="Server url"
                                    IsEnabled="{Binding UseDefaultConnection, Converter={StaticResource InverseBooleanConverter}}"
                                    FontSize="13" />
                            </Grid>

                            <!-- Save button only for connection changes -->
                            <Grid
                                Grid.Row="3"
                                ColumnDefinitions="*,Auto"
                                Margin="0,8,0,0">

                                <Label
                                    Grid.Column="0"
                                    Text=""
                                    FontSize="11" />

                                <Button
                                    Grid.Column="1"
                                    Text="Save settings"
                                    Style="{StaticResource PillButtonStyle}"
                                    Command="{Binding SaveCommand}"
                                    IsEnabled="{Binding HasChanges}">

                                    <Button.Triggers>
                                        <!-- When there are valid changes to save, make the button red -->
                                        <DataTrigger
                                            TargetType="Button"
                                            Binding="{Binding HasChanges}"
                                            Value="True">
                                            <Setter Property="BackgroundColor" Value="#dc2626" />
                                            <Setter Property="TextColor" Value="White" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                            </Grid>
                        </Grid>
                    </Border>


                    <!-- CALL LIST BEHAVIOR CARD -->
                    <Border
                        Grid.Row="2"
                        Padding="16"
                        Margin="0,12,0,12"
                        BackgroundColor="{AppThemeBinding Light=White, Dark=#111827}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16">

                        <Border.Stroke>
                            <SolidColorBrush Color="{AppThemeBinding Light=#e5e7eb, Dark=#1f2937}" />
                        </Border.Stroke>

                        <VerticalStackLayout Spacing="8">
                            <Label
                                Text="Call list"
                                FontSize="16"
                                FontAttributes="Bold"
                                TextColor="{AppThemeBinding Light=#111827, Dark=White}" />

                            <Label
                                Text="Control how many calls are kept on screen and which end new calls appear on."
                                FontSize="12"
                                TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />

                            <!-- List direction radio buttons -->
                            <HorizontalStackLayout Spacing="12" Margin="0,8,0,0">
                                <Label
                                    Text="List direction:"
                                    FontSize="12"
                                    VerticalOptions="Center"
                                    TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />

                                <!-- Newest at top -->
                                <RadioButton
                                    Content="Newest at top"
                                    FontSize="12"
                                    GroupName="ScrollDirectionGroup"
                                    IsChecked="{Binding ScrollNewestAtBottom, Converter={StaticResource InverseBooleanConverter}}" />

                                <!-- Newest at bottom -->
                                <RadioButton
                                    Content="Newest at bottom"
                                    FontSize="12"
                                    GroupName="ScrollDirectionGroup"
                                    IsChecked="{Binding ScrollNewestAtBottom}" />
                            </HorizontalStackLayout>

                            <!-- Call list size slider -->
                            <VerticalStackLayout Spacing="4" Margin="0,10,0,0">
                                <Label
                                    Text="{Binding MaxCalls, StringFormat='Keep {0} recent calls'}"
                                    FontSize="12"
                                    TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />

                                <Slider
                                    Minimum="1"
                                    Maximum="25"
                                    Value="{Binding MaxCalls}"
                                    HorizontalOptions="FillAndExpand" />

                                <Label
                                    Text="Use the slider to increase or decrease how many calls stay visible."
                                    FontSize="10"
                                    TextColor="{AppThemeBinding Light=#9ca3af, Dark=#6b7280}" />
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                    </Border>

                    <!-- FILTERS CARD: unified list Receiver > Site > Talkgroup -->
                    <Border
                        Grid.Row="3"
                        Padding="12"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,12">

                        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*">

                            <!-- Header and sort toggle -->
                            <Grid
                                Grid.Row="0"
                                ColumnDefinitions="*,Auto"
                                VerticalOptions="Center"
                                Margin="0,0,0,8">

                                <Label
                                    Grid.Column="0"
                                    Text="Filters"
                                    FontSize="16"
                                    FontAttributes="Bold"
                                    TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                                <HorizontalStackLayout
                                    Grid.Column="1"
                                    Spacing="4"
                                    VerticalOptions="Center">

                                    <Label
                                        Text="Order"
                                        FontSize="11"
                                        VerticalOptions="Center"
                                        TextColor="{AppThemeBinding Light=#4b5563, Dark=#9ca3af}" />

                                    <!-- Simple toggle bound to SortAscending in SettingsViewModel -->
                                    <Switch
                                        IsToggled="{Binding SortAscending}"
                                        Scale="0.8"
                                        HorizontalOptions="End"
                                        VerticalOptions="Center" />
                                </HorizontalStackLayout>
                            </Grid>

                            <!-- Unified filter lines list -->
                            <CollectionView
                                x:Name="FilterLinesView"
                                Grid.Row="1"
                                ItemsSource="{Binding FilterLines}"
                                SelectionMode="None">

                                <CollectionView.ItemTemplate>
                                    <!-- no x:DataType to avoid the nested type resolution error -->
                                    <DataTemplate>
                                        <Border
                                            Margin="0,0,0,6"
                                            Padding="8,2"
                                            StrokeThickness="1"
                                            StrokeShape="RoundRectangle 12">

                                            <!-- Base stroke -->
                                            <Border.Stroke>
                                                <SolidColorBrush Color="{AppThemeBinding Light=#d1d5db, Dark=#374151}" />
                                            </Border.Stroke>

                                            <!-- Color based on IsEnabled -->
                                            <Border.Triggers>
                                                <DataTrigger
                                                    TargetType="Border"
                                                    Binding="{Binding IsEnabled}"
                                                    Value="True">
                                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#dcfce7, Dark=#14532d}" />
                                                    <Setter Property="Stroke" Value="{AppThemeBinding Light=#16a34a, Dark=#14532d}" />
                                                </DataTrigger>
                                                <DataTrigger
                                                    TargetType="Border"
                                                    Binding="{Binding IsEnabled}"
                                                    Value="False">
                                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#fee2e2, Dark=#7f1d1d}" />
                                                    <Setter Property="Stroke" Value="{AppThemeBinding Light=#f87171, Dark=#7f1d1d}" />
                                                </DataTrigger>
                                            </Border.Triggers>

                                            <!-- Row content: Receiver > Site > Talkgroup [X] -->
                                            <HorizontalStackLayout
                                                Spacing="4"
                                                VerticalOptions="Center"
                                                MinimumHeightRequest="0">

                                                <!-- Receiver label: toggles all lines with this receiver -->
                                                <Label
                                                    Text="{Binding Receiver}"
                                                    FontSize="11"
                                                    LineBreakMode="TailTruncation"
                                                    VerticalOptions="Center"
                                                    TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}">
                                                    <Label.GestureRecognizers>
                                                        <TapGestureRecognizer
                                                            Command="{Binding Source={x:Reference SettingsRoot}, Path=BindingContext.ToggleReceiverFilterCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Label.GestureRecognizers>
                                                </Label>

                                                <Label
                                                    Text=">"
                                                    FontSize="11"
                                                    VerticalOptions="Center"
                                                    TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />

                                                <!-- Site label: toggles all lines with this receiver and site -->
                                                <Label
                                                    Text="{Binding Site}"
                                                    FontSize="11"
                                                    LineBreakMode="TailTruncation"
                                                    VerticalOptions="Center"
                                                    TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}">
                                                    <Label.GestureRecognizers>
                                                        <TapGestureRecognizer
                                                            Command="{Binding Source={x:Reference SettingsRoot}, Path=BindingContext.ToggleSiteFilterCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Label.GestureRecognizers>
                                                </Label>

                                                <Label
                                                    Text=">"
                                                    FontSize="11"
                                                    VerticalOptions="Center"
                                                    TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}" />

                                                <!-- Talkgroup label: toggles just this one line -->
                                                <Label
                                                    Text="{Binding Talkgroup}"
                                                    FontSize="11"
                                                    LineBreakMode="TailTruncation"
                                                    VerticalOptions="Center"
                                                    TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}">
                                                    <Label.GestureRecognizers>
                                                        <TapGestureRecognizer
                                                            Command="{Binding Source={x:Reference SettingsRoot}, Path=BindingContext.ToggleFilterLineCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    </Label.GestureRecognizers>
                                                </Label>

                                                <!-- Spacer so the remove button does not crush the text -->
                                                <Label
                                                    Text=""
                                                    HorizontalOptions="FillAndExpand" />

                                                <!-- Remove button: clears this line; new calls will repopulate it -->
                                                <Button
                                                    Text="X"
                                                    FontSize="10"
                                                    Padding="6,0"
                                                    Margin="8,0,0,0"
                                                    VerticalOptions="Center"
                                                    HorizontalOptions="End"
                                                    BackgroundColor="Transparent"
                                                    TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}"
                                                    BorderWidth="0"
                                                    Command="{Binding Source={x:Reference SettingsRoot}, Path=BindingContext.RemoveFilterLineCommand}"
                                                    CommandParameter="{Binding .}" />
                                            </HorizontalStackLayout>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                        </Grid>
                    </Border>

                    <!-- THEME CARD -->
                    <Border
                        Grid.Row="4"
                        Padding="12"
                        BackgroundColor="{AppThemeBinding Light=#f9fafb, Dark=#020617}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        Margin="0,0,0,12">

                        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*">
                            <Label
                                Grid.Row="0"
                                Text="Theme"
                                FontSize="16"
                                FontAttributes="Bold"
                                Margin="0,0,0,8"
                                TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />

                            <HorizontalStackLayout
                                Grid.Row="1"
                                Spacing="12">

                                <RadioButton
                                    Content="System"
                                    GroupName="ThemeMode"
                                    IsChecked="{Binding IsThemeSystem}" />

                                <RadioButton
                                    Content="Light"
                                    GroupName="ThemeMode"
                                    IsChecked="{Binding IsThemeLight}" />

                                <RadioButton
                                    Content="Dark"
                                    GroupName="ThemeMode"
                                    IsChecked="{Binding IsThemeDark}" />
                            </HorizontalStackLayout>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </ScrollView>
</ContentPage>
