<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="JoesScanner.Views.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:JoesScanner.ViewModels"
    xmlns:controls="clr-namespace:JoesScanner.Views.Controls"
    xmlns:models="clr-namespace:JoesScanner.Models"
    x:Name="Page"
    x:DataType="vm:MainViewModel"
    Title="Joes Scanner"
    BackgroundColor="{StaticResource TabStripNavy}"
    Shell.NavBarIsVisible="False"
    Shell.TabBarIsVisible="False">

    <!-- Root grid fills the window -->
    <Grid
        Padding="5,0,5,5"
        RowDefinitions="Auto,*"
        RowSpacing="0">

        <controls:AppTabStrip
            Grid.Row="0"
            SelectedTab="{x:Static models:AppTab.Main}" />

        <!-- Outer card that fills the available area -->
        <Border
            Grid.Row="1"
            StrokeThickness="0"
            BackgroundColor="{AppThemeBinding Light=White, Dark=#020617}"
            VerticalOptions="Fill"
            HorizontalOptions="Fill">

            <Border.StrokeShape>
                <RoundRectangle CornerRadius="10" />
            </Border.StrokeShape>

            <!-- Inner grid: header, calls, footer -->
            <Grid
                RowDefinitions="Auto,*,Auto"
                ColumnDefinitions="*"
                ColumnSpacing="0">

                <!-- HEADER PANEL: single merged box (buttons + indicators) -->
                <Border
                    Grid.Row="0"
                    HeightRequest="50"
                    StrokeThickness="1"
                    Stroke="#0D0D28"
                    BackgroundColor="#0D0D28"
                    Padding="2,0"
                    VerticalOptions="Center"
                    HorizontalOptions="Center">

                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10" />
                    </Border.StrokeShape>

                    <Grid
                        ColumnDefinitions="Auto,80"
                        ColumnSpacing="0"
                        Padding="2"
                        VerticalOptions="Center"
                        HorizontalOptions="Center">

                        <!-- Media buttons strip -->
                        <ScrollView
                            Grid.Column="0"
                            Orientation="Horizontal"
                            HorizontalScrollBarVisibility="Never"
                            VerticalScrollBarVisibility="Never"
                            Padding="0"
                            Margin="0">

                            <HorizontalStackLayout
                                Spacing="0"
                                HorizontalOptions="Start"
                                VerticalOptions="Center">

                                <ImageButton
                                    Source="mc_previous.png"
                                    Command="{Binding PreviousCallCommand}"
                                    IsEnabled="{Binding IsMediaButtonsEnabled}"
                                    BackgroundColor="Transparent"
                                    HeightRequest="38"
                                    WidthRequest="38"
                                    Padding="0"
                                    AutomationId="MediaPrevious"
                                    SemanticProperties.Description="Previous call"
                                    ToolTipProperties.Text="Previous call" />

                                <ImageButton
                                    Source="{Binding MediaPlayStopIcon}"
                                    Command="{Binding ToggleConnectionCommand}"
                                    BackgroundColor="Transparent"
                                    HeightRequest="38"
                                    WidthRequest="38"
                                    Padding="0"
                                    AutomationId="MediaPlayStop"
                                    SemanticProperties.Description="Connect or disconnect"
                                    ToolTipProperties.Text="Connect or disconnect" />

                                <ImageButton
                                    Source="mc_next.png"
                                    Command="{Binding NextCallCommand}"
                                    IsEnabled="{Binding IsMediaButtonsEnabled}"
                                    BackgroundColor="Transparent"
                                    HeightRequest="38"
                                    WidthRequest="38"
                                    Padding="0"
                                    AutomationId="MediaNext"
                                    SemanticProperties.Description="Next call"
                                    ToolTipProperties.Text="Next call" />

                                <ImageButton
                                    Source="mc_jump_to_live.png"
                                    Command="{Binding JumpToLiveCommand}"
                                    IsEnabled="{Binding IsMediaButtonsEnabled}"
                                    BackgroundColor="Transparent"
                                    HeightRequest="38"
                                    WidthRequest="38"
                                    Padding="0"
                                    AutomationId="MediaJumpToLive"
                                    SemanticProperties.Description="Jump to live"
                                    ToolTipProperties.Text="Jump to live" />

                                <ImageButton
                                    Source="mc_speeddown.png"
                                    Command="{Binding PlaybackSpeedDownCommand}"
                                    IsEnabled="{Binding IsSpeedButtonsEnabled}"
                                    BackgroundColor="Transparent"
                                    HeightRequest="38"
                                    WidthRequest="38"
                                    Padding="0"
                                    AutomationId="MediaRewindDouble"
                                    SemanticProperties.Description="Speed down"
                                    ToolTipProperties.Text="Speed down" />

                                <ImageButton
                                    Source="mc_speedup.png"
                                    Command="{Binding PlaybackSpeedUpCommand}"
                                    IsEnabled="{Binding IsSpeedButtonsEnabled}"
                                    BackgroundColor="Transparent"
                                    HeightRequest="38"
                                    WidthRequest="38"
                                    Padding="0"
                                    AutomationId="MediaFastForwardDouble"
                                    SemanticProperties.Description="Speed up"
                                    ToolTipProperties.Text="Speed up" />

                                <ImageButton
                                    Source="mc_volume.png"
                                    Command="{Binding ToggleAudioCommand}"
                                    IsEnabled="{Binding IsMediaButtonsEnabled}"
                                    BackgroundColor="Transparent"
                                    HeightRequest="38"
                                    WidthRequest="38"
                                    Padding="0"
                                    AutomationId="MediaVolume"
                                    SemanticProperties.Description="Toggle audio"
                                    ToolTipProperties.Text="Toggle audio" />

                            </HorizontalStackLayout>
                        </ScrollView>

                        <!-- Indicators area (fixed width) -->
                        <Grid
                            Grid.Column="1"
                            Padding="0"
                            RowDefinitions="Auto,Auto,Auto"
                            ColumnDefinitions="*"
                            VerticalOptions="Start">

                            <Border
                                WidthRequest="60"
                                HeightRequest="8"
                                Margin="0,3,0,0"
                                BackgroundColor="{Binding ConnectionStatusColor}"
                                StrokeThickness="0"
                                HorizontalOptions="Center"
                                Padding="0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="4" />
                                </Border.StrokeShape>
                            </Border>

                            <Label
                                Grid.Row="1"
                                IsVisible="{Binding IsCallsWaitingVisible}"
                                Text="{Binding PlaybackSpeedLabel, StringFormat='Speed: {0}'}"
                                FontSize="9"
                                FontAutoScalingEnabled="False"
                                Margin="0,2"
                                LineBreakMode="NoWrap"
                                HorizontalTextAlignment="Center"
                                TextColor="White" />

                            <Label
                                Grid.Row="2"
                                IsVisible="{Binding IsCallsWaitingVisible}"
                                Text="{Binding CallsWaiting, StringFormat='Calls waiting: {0}'}"
                                FontSize="9"
                                FontAutoScalingEnabled="False"
                                LineBreakMode="NoWrap"
                                HorizontalTextAlignment="Center"
                                TextColor="White" />
                        </Grid>

                    </Grid>
                </Border>

                <!-- CALL LIST -->
                <CollectionView
                    Grid.Row="1"
                    x:Name="CallsView"
                    ItemsSource="{Binding Calls}"
                    SelectionMode="Single"
                    SelectionChanged="OnCallSelectionChanged"
                    ItemsUpdatingScrollMode="KeepScrollOffset"
                    ItemSizingStrategy="MeasureAllItems"
                    VerticalOptions="Fill"
                    HorizontalOptions="Fill"
                    Margin="10,8,10,0">

                    <CollectionView.Header>
                        <BoxView HeightRequest="2" BackgroundColor="Transparent" />
                    </CollectionView.Header>

                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="0" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:CallItem">
                            <!-- Single call card -->
                            <Border
                                HorizontalOptions="Fill"
                                Padding="{OnPlatform WinUI=6, MacCatalyst=6, Android=5, iOS=5}"
                                BackgroundColor="{AppThemeBinding Light=White, Dark=#111827}"
                                StrokeThickness="1"
                                StrokeShape="RoundRectangle 8">

                                <Border.Stroke>
                                    <SolidColorBrush Color="{AppThemeBinding Light=#374151, Dark=#1f2937}" />
                                </Border.Stroke>


                                <Border.Triggers>
                                    <DataTrigger
                                        TargetType="Border"
                                        Binding="{Binding IsPlaying}"
                                        Value="True">
                                        <Setter Property="StrokeThickness" Value="2" />
                                        <Setter Property="Stroke" Value="#22c55e" />
                                        <Setter Property="BackgroundColor"
                                                Value="{AppThemeBinding Light=#ecfdf5, Dark=#022c22}" />
                                        <Setter Property="Opacity" Value="1" />
                                    </DataTrigger>
                                </Border.Triggers>

                                <!-- Call layout: header row, transcription, debug -->
                                <Grid
                                    ColumnDefinitions="*,Auto"
                                    RowDefinitions="Auto,Auto,Auto"
                                    RowSpacing="{OnPlatform WinUI=4, MacCatalyst=4, Android=2, iOS=2}"
                                    ColumnSpacing="6">

                                    <!-- Header row: time > receiver > site > talkgroup -->
                                    <Label
                                        Grid.Row="0"
                                        Grid.Column="0"
                                        FontSize="{OnPlatform WinUI=12, MacCatalyst=12, Android=11, iOS=11}"
                                        FontAutoScalingEnabled="False"
                                        MaxLines="1"
                                        LineBreakMode="TailTruncation">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span
                                                    Text="{Binding TimeDisplay}"
                                                    FontAttributes="Bold"
                                                    TextColor="{AppThemeBinding Light=#111827, Dark=White}" />
                                                <Span Text=" > " />
                                                <Span
                                                    Text="{Binding ReceiverName}"
                                                    TextColor="{AppThemeBinding Light=#374151, Dark=#9ca3af}" />
                                                <Span Text=" > " />
                                                <Span
                                                    Text="{Binding SystemName}"
                                                    TextColor="{AppThemeBinding Light=#374151, Dark=#9ca3af}" />
                                                <Span Text=" > " />
                                                <Span
                                                    Text="{Binding Talkgroup}"
                                                    FontAttributes="Bold"
                                                    TextColor="{AppThemeBinding Light=#111827, Dark=#bfdbfe}" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                    <!-- Duration on the right -->
                                    <Label
                                        Grid.Row="0"
                                        Grid.Column="1"
                                        HorizontalTextAlignment="End"
                                        VerticalTextAlignment="Center"
                                        FontSize="{OnPlatform WinUI=10, MacCatalyst=10, Android=9, iOS=9}"
                                        FontAutoScalingEnabled="False"
                                        Text="{Binding DurationDisplay}"
                                        TextColor="{AppThemeBinding Light=#4b5563, Dark=#9ca3af}" />

                                    <!-- Transcription (only show when there is real text) -->
                                    <Label
                                        Grid.Row="1"
                                        Grid.Column="0"
                                        Grid.ColumnSpan="2"
                                        Margin="0,2,0,0"
                                        FontSize="{OnPlatform WinUI=12, MacCatalyst=12, Android=11, iOS=11}"
                                        FontAutoScalingEnabled="False"
                                        LineBreakMode="WordWrap"
                                        TextColor="{AppThemeBinding Light=#374151, Dark=#e5e7eb}"
                                        MaxLines="4"
                                        Text="{Binding Transcription, TargetNullValue=''}">

                                        <Label.Triggers>
                                            <!-- Hide when empty -->
                                            <DataTrigger
                                                TargetType="Label"
                                                Binding="{Binding Transcription, TargetNullValue=''}"
                                                Value="">
                                                <Setter Property="IsVisible" Value="False" />
                                                <Setter Property="Margin" Value="0" />
                                            </DataTrigger>

                                            <!-- Hide when server sends the placeholder string -->
                                            <DataTrigger
                                                TargetType="Label"
                                                Binding="{Binding Transcription, TargetNullValue=''}"
                                                Value="No transcription from server">
                                                <Setter Property="IsVisible" Value="False" />
                                                <Setter Property="Margin" Value="0" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>

                                    <!-- Debug or error info -->
                                    <Label
                                        Grid.Row="2"
                                        Grid.Column="0"
                                        Grid.ColumnSpan="2"
                                        Margin="0,2,0,0"
                                        FontSize="{OnPlatform WinUI=10, MacCatalyst=10, Android=9, iOS=9}"
                                        FontAutoScalingEnabled="False"
                                        LineBreakMode="WordWrap"
                                        MaxLines="3"
                                        TextColor="{AppThemeBinding Light=#b91c1c, Dark=#fecaca}"
                                        IsVisible="{Binding HasDebugInfo}"
                                        Text="{Binding DebugInfo}" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- FOOTER: client info and donate button -->
                <Grid
                    Grid.Row="2"
                    Padding="20,5,20,5"
                    RowDefinitions="Auto"
                    ColumnDefinitions="*,Auto">

                    <!-- Desktop only label -->
                    <Label
                        Grid.Row="0"
                        Grid.Column="0"
                        FontSize="11"
                        VerticalOptions="End"
                        TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}"
                        LineBreakMode="TailTruncation"
                        IsVisible="{OnPlatform WinUI=true, MacCatalyst=true, Android=false, iOS=false}"
                        Text="JoesScanner desktop client">
                        <Label.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSiteTapped" />
                        </Label.GestureRecognizers>
                    </Label>

                    <!-- Donate button -->
                    <Button
                        Grid.Column="1"
                        Text="Donate to the app developer"
                        Style="{StaticResource SecondaryPillButtonStyle}"
                        FontSize="10"
                        Command="{Binding OpenDonateCommand}" />
                </Grid>

            </Grid>
        </Border>
    </Grid>
</ContentPage>
