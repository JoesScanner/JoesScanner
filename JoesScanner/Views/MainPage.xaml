<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="JoesScanner.Views.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:JoesScanner.ViewModels"
    xmlns:models="clr-namespace:JoesScanner.Models"
    x:Name="Page"
    Title="Joes Scanner"
    BackgroundColor="{AppThemeBinding Light=#f3f4f6, Dark=#020617}"
    Shell.NavBarIsVisible="False">

    <!-- Root grid fills the window -->
    <Grid Padding="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Outer card that fills the available area -->
        <Border
            StrokeThickness="0"
            BackgroundColor="{AppThemeBinding Light=White, Dark=#020617}"
            StrokeShape="RoundRectangle 24"
            VerticalOptions="FillAndExpand"
            HorizontalOptions="FillAndExpand">

            <Border.Shadow>
                <Shadow
                    Brush="#000000"
                    Offset="0,1"
                    Radius="8"
                    Opacity="0.10" />
            </Border.Shadow>

            <!-- Inner grid: header, calls, footer -->
            <Grid
                RowDefinitions="Auto,*,Auto"
                ColumnDefinitions="*">

                <!-- HEADER PANEL: title, server, controls -->
                <Grid
                    Grid.Row="0"
                    RowDefinitions="Auto,Auto,Auto"
                    ColumnDefinitions="Auto,*,Auto"
                    Padding="16,16,16,8"
                    ColumnSpacing="16">

                    <!-- Row 0: logo + title -->
                    <HorizontalStackLayout
                        Grid.Row="0"
                        Grid.Column="0"
                        Spacing="8"
                        VerticalOptions="Center">

                        <!-- Logo to the left of title -->
                        <Image
                            Source="logo.png"
                            HeightRequest="40"
                            WidthRequest="40"
                            VerticalOptions="Center"
                            Aspect="AspectFit" />

                        <VerticalStackLayout
                            Spacing="0"
                            VerticalOptions="Center">

                            <Label
                                Text="JoesScanner"
                                FontSize="25"
                                FontAttributes="Bold"
                                TextColor="{AppThemeBinding Light=#111827, Dark=White}" />

                            <!-- Optional: Tagline 'Server: <url>' from TaglineText -->
                            <Label
                                Text="Hear the Action, Know the Story!"
                                FontSize="10"
                                TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}"
                                HorizontalOptions="Start"
                                VerticalOptions="Center" />
                            
                        </VerticalStackLayout>
                    </HorizontalStackLayout>

                    <!-- Row 1 left: connection status (dot + text) -->
                    <StackLayout
                        Grid.Row="1"
                        Grid.Column="0"
                        Orientation="Horizontal"
                        Spacing="6"
                        VerticalOptions="Center">

                        <!-- Connection dot -->
                        <BoxView
                            WidthRequest="8"
                            HeightRequest="8"
                            Color="{Binding ConnectionStatusColor}"
                            CornerRadius="4"
                            VerticalOptions="Center" />

                        <!-- Connection status text only -->
                        <Label
                            Text="{Binding ConnectionStatusText}"
                            FontSize="12"
                            VerticalOptions="Center" />
                    </StackLayout>

                    <!-- Row 1 right: buttons aligned to the end -->
                    <HorizontalStackLayout
                        Grid.Row="1"
                        Grid.Column="2"
                        Spacing="4"
                        VerticalOptions="Center"
                        HorizontalOptions="End">

                        <!-- Jump to live button -->
                        <Button
                            Text="Jump to live"
                            Command="{Binding JumpToLiveCommand}"
                            Style="{StaticResource SecondaryPillButtonStyle}"
                            Margin="4,0,0,0" />

                        <!-- Connect or Disconnect button -->
                        <Button
                            Style="{StaticResource PillButtonStyle}"
                            Margin="0,0,0,0"
                            Text="Connect"
                            Command="{Binding StartCommand}">
                            <Button.Triggers>
                                <DataTrigger
                                    TargetType="Button"
                                    Binding="{Binding IsRunning}"
                                    Value="True">
                                    <Setter Property="Text" Value="Disconnect" />
                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#16a34a, Dark=#15803d}" />
                                    <Setter Property="Command" Value="{Binding StopCommand}" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>

                        <!-- Settings button -->
                        <Button
                            Text="Settings"
                            Clicked="OnSettingsTapped"
                            Style="{StaticResource SecondaryPillButtonStyle}"
                            Margin="4,0,0,0" />
                    </HorizontalStackLayout>

                    <!-- Row 2: audio, speed, calls waiting -->
                    <HorizontalStackLayout
                        Grid.Row="2"
                        Grid.Column="0"
                        Grid.ColumnSpan="3"
                        Spacing="12"
                        VerticalOptions="Center">

                        <!-- Audio On or Off button (global audio control) -->
                        <Button
                            Text="{Binding AudioButtonText}"
                            Command="{Binding ToggleAudioCommand}"
                            Style="{StaticResource SecondaryPillButtonStyle}"
                            BackgroundColor="{Binding AudioButtonBackground}"
                            VerticalOptions="Center" />

                        <!-- Playback speed slider and label -->
                        <HorizontalStackLayout
                            Spacing="4"
                            VerticalOptions="Center">

                            <Label
                                IsVisible="{Binding AudioEnabled}"
                                Text="Speed"
                                FontSize="11"
                                VerticalOptions="Center"
                                TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />

                            <Slider
                                IsVisible="{Binding AudioEnabled}"
                                WidthRequest="90"
                                Minimum="0"
                                Maximum="2"
                                Value="{Binding PlaybackSpeedStep}"
                                VerticalOptions="Center" />

                            <Label
                                IsVisible="{Binding AudioEnabled}"
                                Text="{Binding PlaybackSpeedLabel}"
                                FontSize="11"
                                VerticalOptions="Center"
                                TextColor="{AppThemeBinding Light=#111827, Dark=#e5e7eb}" />
                        </HorizontalStackLayout>

                        <!-- Calls waiting indicator to the right of the speed slider -->
                        <Label
                            IsVisible="{Binding IsCallsWaitingVisible}"
                            Text="{Binding CallsWaiting, StringFormat='Calls waiting: {0}'}"
                            FontSize="10"
                            VerticalOptions="Center"
                            Margin="6,0,0,0"
                            TextColor="{AppThemeBinding Light=#4b5563, Dark=#d1d5db}" />
                    </HorizontalStackLayout>
                </Grid>

                <!-- CALL LIST -->
                <CollectionView
                    Grid.Row="1"
                    x:Name="CallsView"
                    ItemsSource="{Binding Calls}"
                    ItemsUpdatingScrollMode="KeepScrollOffset"
                    ItemsLayout="VerticalList"
                    VerticalOptions="FillAndExpand">

                    <CollectionView.ItemTemplate>
                        <DataTemplate>

                            <!-- Single call card -->
                            <Border
                                Margin="0,0,0,8"
                                Padding="6"
                                BackgroundColor="{AppThemeBinding Light=White, Dark=#111827}"
                                StrokeThickness="1"
                                StrokeShape="RoundRectangle 8">

                                <!-- Default border stroke -->
                                <Border.Stroke>
                                    <SolidColorBrush Color="{AppThemeBinding Light=#374151, Dark=#1f2937}" />
                                </Border.Stroke>

                                <!-- Tap anywhere on the card to replay the call -->
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer
                                        Command="{Binding BindingContext.PlayAudioCommand, Source={x:Reference Page}}"
                                        CommandParameter="{Binding .}" />
                                </Border.GestureRecognizers>

                                <!-- Highlight / history flags -->
                                <Border.Triggers>
                                    <DataTrigger
                                        TargetType="Border"
                                        Binding="{Binding IsHistory}"
                                        Value="True">
                                        <Setter Property="Opacity" Value="0.55" />
                                    </DataTrigger>

                                    <DataTrigger
                                        TargetType="Border"
                                        Binding="{Binding IsPlaying}"
                                        Value="True">
                                        <Setter Property="StrokeThickness" Value="2" />
                                        <Setter Property="Stroke" Value="#22c55e" />
                                        <Setter Property="BackgroundColor"
                                                Value="{AppThemeBinding Light=#ecfdf5, Dark=#022c22}" />
                                        <Setter Property="Opacity" Value="1" />
                                    </DataTrigger>
                                </Border.Triggers>

                                <!-- Call layout: header row + transcription + debug -->
                                <Grid
                                    ColumnDefinitions="*,Auto"
                                    RowDefinitions="Auto,Auto,Auto">

                                    <!-- Header row: time > receiver > site > talkgroup -->
                                    <Label
                                        Grid.Row="0"
                                        Grid.Column="0">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span
                                                    Text="{Binding TimeDisplay}"
                                                    FontAttributes="Bold"
                                                    TextColor="{AppThemeBinding Light=#111827, Dark=White}" />
                                                <Span Text=" > " />
                                                <Span
                                                    Text="{Binding ReceiverName}"
                                                    TextColor="{AppThemeBinding Light=#374151, Dark=#9ca3af}" />
                                                <Span Text=" > " />
                                                <Span
                                                    Text="{Binding SystemName}"
                                                    TextColor="{AppThemeBinding Light=#374151, Dark=#9ca3af}" />
                                                <Span Text=" > " />
                                                <Span
                                                    Text="{Binding Talkgroup}"
                                                    FontAttributes="Bold"
                                                    TextColor="{AppThemeBinding Light=#111827, Dark=#bfdbfe}" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                    <!-- Duration on the right -->
                                    <Label
                                        Grid.Row="0"
                                        Grid.Column="1"
                                        HorizontalTextAlignment="End"
                                        VerticalTextAlignment="Center"
                                        FontSize="11"
                                        TextColor="{AppThemeBinding Light=#4b5563, Dark=#9ca3af}">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding DurationDisplay}" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                    <!-- Transcription row -->
                                    <Label
                                        Grid.Row="1"
                                        Grid.Column="0"
                                        Grid.ColumnSpan="2"
                                        Margin="0,4,0,0"
                                        FontSize="12"
                                        LineBreakMode="WordWrap"
                                        TextColor="{AppThemeBinding Light=#374151, Dark=#e5e7eb}"
                                        MaxLines="4">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding Transcription}" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>

                                    <!-- Debug / error info -->
                                    <Label
                                        Grid.Row="2"
                                        Grid.Column="0"
                                        Grid.ColumnSpan="2"
                                        Margin="0,2,0,0"
                                        FontSize="10"
                                        LineBreakMode="WordWrap"
                                        MaxLines="3"
                                        TextColor="{AppThemeBinding Light=#b91c1c, Dark=#fecaca}"
                                        IsVisible="{Binding HasDebugInfo}"
                                        Text="{Binding DebugInfo}" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- FOOTER: client info and donate button -->
                <Grid
                    Grid.Row="2"
                    Padding="16,8,16,16"
                    RowDefinitions="Auto"
                    ColumnDefinitions="*,Auto">

                    <!-- Desktop-only label -->
                    <Label
                        Grid.Row="0"
                        Grid.Column="0"
                        FontSize="11"
                        TextColor="{AppThemeBinding Light=#6b7280, Dark=#9ca3af}"
                        LineBreakMode="TailTruncation"
                        IsVisible="{OnPlatform WinUI=true, MacCatalyst=true, Android=false, iOS=false}">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="JoesScanner desktop client" />
                            </FormattedString>
                        </Label.FormattedText>
                        <Label.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSiteTapped" />
                        </Label.GestureRecognizers>
                    </Label>

                    <!-- Donate button -->
                    <Button
                        Grid.Column="1"
                        Text="Donate to the app developer"
                        Style="{StaticResource SecondaryPillButtonStyle}"
                        FontSize="10"
                        Command="{Binding OpenDonateCommand}" />
                </Grid>
            </Grid>
        </Border>
    </Grid>
</ContentPage>
